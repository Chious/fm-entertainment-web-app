---
import Layout from '@/layouts/Layout.astro';
import SearchBar from '@/components/SearchBar.astro';
import SearchScript from '@/components/SearchScript.astro';
import LazyMediaCard from '@/components/LazyMediaCard.astro';
import { fetchBookmarkedMedia, filterMedia } from '@/lib/media';

// Set cache header
Astro.response.headers.set('Cache-Control', 'public, max-age=1800, stale-while-revalidate=3600');

// Fetch bookmarked items from OMDB API
const bookmarkedItems = await fetchBookmarkedMedia();

// Separate by category
const bookmarkedMovies = filterMedia(bookmarkedItems, { category: "Movie" });
const bookmarkedTVSeries = filterMedia(bookmarkedItems, { category: "TV Series" });
---

<Layout title="Bookmarked - Entertainment Web App">
	<div class="w-full max-w-[1440px] mx-auto">
		<SearchBar placeholder="Search for bookmarked shows" />

		{bookmarkedMovies.length > 0 && (
			<section class="mb-8">
				<h2 class="text-xl md:text-[32px] font-light tracking-tight md:tracking-[-0.5px] mb-4 md:mb-6 text-pure-white">Bookmarked Movies</h2>
				<div class="grid grid-cols-2 gap-4 md:grid-cols-3 md:gap-y-6 md:gap-x-8 lg:grid-cols-4 lg:gap-y-8 lg:gap-x-10">
					{bookmarkedMovies.map((item, index) => (
						<LazyMediaCard
							title={item.title}
							thumbnail={item.thumbnail.regular}
							year={item.year}
							category={item.category as "Movie" | "TV Series"}
							rating={item.rating}
							isBookmarked={item.isBookmarked}
							index={index}
							loading={index < 5 ? "eager" : "lazy"}
						/>
					))}
				</div>
			</section>
		)}

		{bookmarkedTVSeries.length > 0 && (
			<section class="mb-8">
				<h2 class="text-xl md:text-[32px] font-light tracking-tight md:tracking-[-0.5px] mb-4 md:mb-6 text-pure-white">Bookmarked TV Series</h2>
				<div class="grid grid-cols-2 gap-4 md:grid-cols-3 md:gap-y-6 md:gap-x-8 lg:grid-cols-4 lg:gap-y-8 lg:gap-x-10">
					{bookmarkedTVSeries.map((item, index) => (
						<LazyMediaCard
							title={item.title}
							thumbnail={item.thumbnail.regular}
							year={item.year}
							category={item.category as "Movie" | "TV Series"}
							rating={item.rating}
							isBookmarked={item.isBookmarked}
							index={index}
							loading={bookmarkedMovies.length === 0 && index < 4 ? "eager" : "lazy"}
						/>
					))}
				</div>
			</section>
		)}

		{bookmarkedMovies.length === 0 && bookmarkedTVSeries.length === 0 && (
			<div class="flex flex-col items-center justify-center py-20">
				<p class="text-pure-white text-xl md:text-2xl opacity-50">No bookmarked shows yet</p>
			</div>
		)}
	</div>

	<SearchScript bookmarkedOnly={true} />
</Layout>

