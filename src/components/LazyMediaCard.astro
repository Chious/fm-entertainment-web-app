---
import { Image } from "astro:assets";
import BookmarkButton from "./BookmarkButton";
import movieIcon from "@/assets/icon-category-movie.svg";
import tvIcon from "@/assets/icon-category-tv.svg";
import playIcon from "@/assets/icon-play.svg";

interface Props {
  title: string;
  thumbnail: string | {
    small: string;
    medium: string;
    large: string;
  };
  year: number;
  category: "Movie" | "TV Series";
  rating: string;
  isBookmarked: boolean;
  index: number;
  loading?: "eager" | "lazy";
}

const { title, thumbnail, year, category, rating, isBookmarked, index, loading = "lazy" } = Astro.props;

// Handle both string and object thumbnail formats - use medium size for optimal quality
const thumbnailUrl = typeof thumbnail === 'string' ? thumbnail : thumbnail.medium;
---

<div class="lazy-load relative cursor-pointer opacity-0 translate-y-5 transition-all duration-600 ease-in-out group" data-index={index}>
  <div class="relative rounded-lg overflow-hidden mb-2 image-container">
    <Image 
      src={thumbnailUrl}
      alt={title}
      class="w-full h-auto block transition-transform duration-300 ease-in-out group-hover:scale-105"
      loading={loading}
      inferSize={true}
    />
    <div class="image-skeleton w-full aspect-2/3 rounded-lg bg-semi-dark-blue animate-pulse" style="display: none; min-height: 300px;"></div>
    
    <div class="absolute top-2 right-2 md:top-4 md:right-4 z-2">
      <BookmarkButton 
        client:only="react" 
        title={title}
        year={year}
        category={category}
        rating={rating}
        thumbnail={thumbnail}
      />
    </div>

    <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
      <button class="flex items-center gap-4 py-2 px-6 bg-white/25 hover:bg-white/35 border-none rounded-[28px] text-pure-white font-medium text-lg cursor-pointer transition-all" aria-label={`Play ${title}`}>
        <Image src={playIcon} alt="Play" class="w-[30px] h-[30px]" loading={loading}/>
        <span>Play</span>
      </button>
    </div>
  </div>

  <div class="flex flex-col gap-1">
    <div class="flex items-center gap-2 text-[11px] md:text-[13px] font-light text-pure-white opacity-75">
      <span>{year}</span>
      <span class="text-[8px]">•</span>
      <span class="flex items-center gap-1">
        <Image 
          src={category === "Movie" ? movieIcon : tvIcon} 
          alt={category}
          class="w-3 h-3 md:w-3.5 md:h-3.5"
        />
        {category}
      </span>
      <span class="text-[8px]">•</span>
      <span>{rating}</span>
    </div>
    <h3 class="text-sm md:text-lg lg:text-2xl font-medium text-pure-white m-0">{title}</h3>
  </div>
</div>

<style>
  .lazy-load.loaded {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  // Intersection Observer for lazy loading animation
  function initLazyLoad() {
    if (typeof window === 'undefined') return;
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const card = entry.target as HTMLElement;
          const index = parseInt(card.dataset.index || '0');
          
          // Stagger the animation based on index
          setTimeout(() => {
            card.classList.add('loaded');
          }, index * 50);
          
          observer.unobserve(card);
        }
      });
    }, {
      rootMargin: '50px',
      threshold: 0.1
    });

    // Observe all lazy load cards that aren't already loaded
    document.querySelectorAll('.lazy-load:not(.loaded)').forEach(card => {
      observer.observe(card);
    });
  }
  
  function handleImageErrors() {
    const images = document.querySelectorAll('.image-container img');
    images.forEach((img: Element) => {
      img.addEventListener('error', function(this: HTMLImageElement) {
        const container = this.closest('.image-container');
        if (container) {
          container.classList.add('image-error');
          this.style.display = 'none';
        }
      });
    });
  }
  
  // Run on initial load
  document.addEventListener('DOMContentLoaded', () => {
    initLazyLoad();
    handleImageErrors();
  });
  
  // Run after view transitions
  document.addEventListener('astro:page-load', () => {
    initLazyLoad();
    handleImageErrors();
  });
</script>

<style>
  .image-container.image-error .image-skeleton {
    display: block !important;
  }
</style>
