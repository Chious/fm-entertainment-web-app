---
import { Image } from "astro:assets";
import BookmarkButton from "./BookmarkButton";
import movieIcon from "@/assets/icon-category-movie.svg";
import tvIcon from "@/assets/icon-category-tv.svg";
import playIcon from "@/assets/icon-play.svg";

interface Props {
  title: string;
  thumbnail: string | {
    small: string;
    medium: string;
    large: string;
  };
  year: number;
  category: "Movie" | "TV Series";
  rating: string;
  isBookmarked: boolean;
}

const { title, thumbnail, year, category, rating, isBookmarked } = Astro.props;

// Handle both string and object thumbnail formats - use large size for backdrop images
const thumbnailUrl = typeof thumbnail === 'string' ? thumbnail : thumbnail.large;
---

<div class="relative cursor-pointer flex-none w-60 md:w-[470px] group">
  <div class="relative rounded-lg overflow-hidden h-[140px] md:h-[230px] image-container">
    <Image 
      src={thumbnailUrl}
      alt={title}
      class="w-full h-full object-cover block transition-transform duration-300 ease-in-out group-hover:scale-105"
      loading="eager"
      fetchpriority="high"
      inferSize={true}
    />
    <div class="image-skeleton w-full h-full rounded-lg bg-semi-dark-blue animate-pulse" style="display: none; min-height: 400px;"></div>
    
    <div class="absolute top-2 right-2 md:top-4 md:right-4 z-2">
      <BookmarkButton 
        client:only="react" 
        title={title}
        year={year}
        category={category}
        rating={rating}
        thumbnail={thumbnail}
      />
    </div>

    <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
      <button class="flex items-center gap-4 py-2 px-6 bg-white/25 hover:bg-white/35 border-none rounded-[28px] text-pure-white font-medium text-lg cursor-pointer transition-all" aria-label={`Play ${title}`}>
        <Image src={playIcon} alt="Play" class="w-[30px] h-[30px]" loading="eager"/>
        <span>Play</span>
      </button>
    </div>

    <div class="absolute bottom-4 left-4 right-4 md:bottom-6 md:left-6 md:right-6 flex flex-col gap-1">
      <div class="flex items-center gap-2 text-xs md:text-[15px] font-light text-pure-white opacity-75">
        <span>{year}</span>
        <span class="text-[8px]">•</span>
        <span class="flex items-center gap-1.5">
          <Image 
            src={category === "Movie" ? movieIcon : tvIcon} 
            alt={category}
            class="w-3 h-3 md:w-3.5 md:h-3.5"
            loading="eager"
          />
          {category}
        </span>
        <span class="text-[8px]">•</span>
        <span>{rating}</span>
      </div>
      <h3 class="text-[15px] md:text-2xl font-medium text-pure-white m-0">{title}</h3>
    </div>
  </div>
</div>

<script>
  function handleImageErrors() {
    const images = document.querySelectorAll('.image-container img');
    images.forEach((img: Element) => {
      img.addEventListener('error', function(this: HTMLImageElement) {
        const container = this.closest('.image-container');
        if (container) {
          container.classList.add('image-error');
          this.style.display = 'none';
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', handleImageErrors);
  document.addEventListener('astro:page-load', handleImageErrors);
</script>

<style>
  .image-container.image-error .image-skeleton {
    display: block !important;
  }
</style>
